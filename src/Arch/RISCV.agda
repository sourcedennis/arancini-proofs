{-# OPTIONS --safe #-}

module Arch.RISCV where

-- Stdlib imports
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; refl) renaming (sym to â‰¡-sym)
open import Data.Product using (_,_; âˆƒ-syntax)
open import Data.Sum using (injâ‚; injâ‚‚)
open import Data.Bool using (Bool)
open import Function using (_âˆ˜_; flip)
open import Relation.Nullary using (Â¬_; yes; no)
open import Relation.Unary using (Pred; Empty)
open import Relation.Binary using (Rel; Irreflexive)
open import Relation.Binary.Construct.Closure.Transitive using (TransClosure; [_]; _âˆ·_)
-- Local library imports
open import Dodo.Nullary
open import Dodo.Unary
open import Dodo.Binary
open import Burrow.Template.Arch as Î 
-- Local imports
open import Helpers


open Tag

-- | RISC-V LD/SC and AMO instructions have 2 bits: "acq" and "rel".
-- (See RISC-V manual sec 8.2 and 8.4)
record Ann : Set where
  constructor _â¦‚annâ¦‚_
  field
    acq rel : Bool

open Bool

pattern ann-none   = false â¦‚annâ¦‚ false
pattern ann-acq    = true  â¦‚annâ¦‚ false
pattern ann-rel    = false â¦‚annâ¦‚ true
pattern ann-acqrel = true  â¦‚annâ¦‚ true


data LabR : Set where
  -- | Read event
  --
  -- The tag indicates which instruction generated the event.
  -- * `tmov` - Either a regular load or a LR (Load Reserved) instruction.
  --     We don't distinguish between regular LOADs and LRs *without*
  --     acq/rel annotations (i.e., `ann-no`).
  -- * `trmw` - Load event, as generated by an AMO instruction
  --
  -- The annotation (`Ann`) indicates which acq/rel flags were set on its
  -- instruction. (See `Ann`)
  lab-r  : Tag â†’ Ann â†’ LabR


data LabW : Set where
  -- | Write event
  --
  -- The tag indicates which instruction generated the event.
  -- * `tmov` - Either a regular write or a SC (Store Conditional) instruction.
  --     We don't distinguish between regular STOREs and SCs *without*
  --     acq/rel annotations (i.e., `ann-no`).
  -- * `trmw` - Store event, as generated by an AMO instruction
  --
  -- The annotation (`Ann`) indicates which acq/rel flags were set on its
  -- instruction. (See `Ann`)
  lab-w  : Tag â†’ Ann â†’ LabW


-- | Classifier for memory accesses. Used in `LabF`.
data AccessClass : Set where
  ğ´R : AccessClass -- read
  ğ´W : AccessClass -- write
  ğ´M : AccessClass -- memory (read / write)


data LabF : Set where
  -- | Orders two classes of accesses
  --
  -- Example:
  -- > ğ´R ğ¹ ğ´W
  -- represents a fence ordering *preceding reads* with *subsequent writes*.
  _ğ¹_ : AccessClass â†’ AccessClass â†’ LabF

  TSO : LabF -- orders WÃ—W and RÃ—M pairs


-- # Lemmas/Properties

lab-r-tag : LabR â†’ Tag
lab-r-tag (lab-r tag _) = tag

lab-w-tag : LabW â†’ Tag
lab-w-tag (lab-w tag _) = tag

bool-decâ‰¡ : Decâ‰¡ Bool
bool-decâ‰¡ false false = yes refl
bool-decâ‰¡ true  true  = yes refl
bool-decâ‰¡ false true  = no (Î» ())
bool-decâ‰¡ true  false = no (Î» ())

ann-decâ‰¡ : Decâ‰¡ Ann
ann-decâ‰¡ (acqâ‚ â¦‚annâ¦‚ relâ‚) (acqâ‚‚ â¦‚annâ¦‚ relâ‚‚) =
  congâ‚‚-dec _â¦‚annâ¦‚_
    (Î»{refl â†’ refl}) (Î»{refl â†’ refl})
    (bool-decâ‰¡ acqâ‚ acqâ‚‚) (bool-decâ‰¡ relâ‚ relâ‚‚)

lab-r-decâ‰¡ : Decâ‰¡ LabR
lab-r-decâ‰¡ (lab-r tagâ‚ annâ‚) (lab-r tagâ‚‚ annâ‚‚) =
  congâ‚‚-dec lab-r
    (Î»{refl â†’ refl}) (Î»{refl â†’ refl})
    (tag-decâ‰¡ tagâ‚ tagâ‚‚) (ann-decâ‰¡ annâ‚ annâ‚‚)

lab-w-decâ‰¡ : Decâ‰¡ LabW
lab-w-decâ‰¡ (lab-w tagâ‚ annâ‚) (lab-w tagâ‚‚ annâ‚‚) =
  congâ‚‚-dec lab-w
    (Î»{refl â†’ refl}) (Î»{refl â†’ refl})
    (tag-decâ‰¡ tagâ‚ tagâ‚‚) (ann-decâ‰¡ annâ‚ annâ‚‚)
    
access-class-decâ‰¡ : Decâ‰¡ AccessClass
access-class-decâ‰¡ ğ´R ğ´R = yes refl
access-class-decâ‰¡ ğ´W ğ´W = yes refl
access-class-decâ‰¡ ğ´M ğ´M = yes refl
access-class-decâ‰¡ ğ´R ğ´W = no (Î»())
access-class-decâ‰¡ ğ´R ğ´M = no (Î»())
access-class-decâ‰¡ ğ´W ğ´R = no (Î»())
access-class-decâ‰¡ ğ´W ğ´M = no (Î»())
access-class-decâ‰¡ ğ´M ğ´R = no (Î»())
access-class-decâ‰¡ ğ´M ğ´W = no (Î»())

lab-f-decâ‰¡ : Decâ‰¡ LabF
lab-f-decâ‰¡ (lâ‚ ğ¹ râ‚) (lâ‚‚ ğ¹ râ‚‚) =
  congâ‚‚-dec _ğ¹_
    (Î»{refl â†’ refl}) (Î»{refl â†’ refl})
    (access-class-decâ‰¡ lâ‚ lâ‚‚) (access-class-decâ‰¡ râ‚ râ‚‚)
lab-f-decâ‰¡ TSO       TSO = yes refl
lab-f-decâ‰¡ TSO       (_ ğ¹ _) = no (Î»())
lab-f-decâ‰¡ (_ ğ¹ _)   TSO     = no (Î»())


arch-RISCV : Arch
arch-RISCV =
  record
    { LabR       = LabR
    ; LabW       = LabW
    ; LabF       = LabF
    ; lab-r-tag  = lab-r-tag
    ; lab-w-tag  = lab-w-tag
    ; lab-r-decâ‰¡ = lab-r-decâ‰¡
    ; lab-w-decâ‰¡ = lab-w-decâ‰¡
    ; lab-f-decâ‰¡ = lab-f-decâ‰¡
    }


pattern RR = ğ´R ğ¹ ğ´R
pattern RW = ğ´R ğ¹ ğ´W
pattern RM = ğ´R ğ¹ ğ´M
pattern WR = ğ´W ğ¹ ğ´R
pattern WW = ğ´W ğ¹ ğ´W
pattern WM = ğ´W ğ¹ ğ´M
pattern MR = ğ´M ğ¹ ğ´R
pattern MW = ğ´M ğ¹ ğ´W
pattern MM = ğ´M ğ¹ ğ´M


open Î .Ev arch-RISCV

EventRISCV = Event -- parameterized over `arch-RISCV`


record RISCVExecution : Setâ‚ where
  field
    dataâ‚‹ : Relâ‚€ Event -- called `dataâ‚‹`, because `data` is a keyword
    addr  : Relâ‚€ Event
    ctrl  : Relâ‚€ Event


module Relations (ex : Execution {arch-RISCV}) (rex : RISCVExecution) where

  open Î .Defs ex
  open RISCVExecution rex

  open import Data.Sum using (_âŠ_)

  -- | Reflexive closure of R
  ReflRel : Relâ‚€ Event â†’ Relâ‚€ Event
  ReflRel R = R âˆªâ‚‚ _â‰¡_


  po-loc-no-w : Relâ‚€ Event
  po-loc-no-w = po-loc \â‚‚ (ReflRel po-loc â¨¾ â¦— EvW â¦˜ â¨¾ po-loc)

  rsw : Relâ‚€ Event
  rsw = flip rf â¨¾ rf

  -- | Fence ordered before
  data Fob (x y : Event) : Set where
    fob-rr : ( â¦— EvR â¦˜  â¨¾ po â¨¾ â¦— EvFâ‚œ RR â¦˜ â¨¾ po â¨¾ â¦— EvR â¦˜ )  x y â†’ Fob x y
    fob-rw : ( â¦— EvR â¦˜  â¨¾ po â¨¾ â¦— EvFâ‚œ RW â¦˜ â¨¾ po â¨¾ â¦— EvW â¦˜ )  x y â†’ Fob x y
    fob-rm : ( â¦— EvR â¦˜  â¨¾ po â¨¾ â¦— EvFâ‚œ RM â¦˜ â¨¾ po â¨¾ â¦— EvRW â¦˜ ) x y â†’ Fob x y

    fob-wr : ( â¦— EvW â¦˜  â¨¾ po â¨¾ â¦— EvFâ‚œ WR â¦˜ â¨¾ po â¨¾ â¦— EvR â¦˜ )  x y â†’ Fob x y
    fob-ww : ( â¦— EvW â¦˜  â¨¾ po â¨¾ â¦— EvFâ‚œ WW â¦˜ â¨¾ po â¨¾ â¦— EvW â¦˜ )  x y â†’ Fob x y
    fob-wm : ( â¦— EvW â¦˜  â¨¾ po â¨¾ â¦— EvFâ‚œ WM â¦˜ â¨¾ po â¨¾ â¦— EvRW â¦˜ ) x y â†’ Fob x y

    fob-mr : ( â¦— EvRW â¦˜ â¨¾ po â¨¾ â¦— EvFâ‚œ MR â¦˜ â¨¾ po â¨¾ â¦— EvR â¦˜ )  x y â†’ Fob x y
    fob-mw : ( â¦— EvRW â¦˜ â¨¾ po â¨¾ â¦— EvFâ‚œ MW â¦˜ â¨¾ po â¨¾ â¦— EvW â¦˜ )  x y â†’ Fob x y
    fob-mm : ( â¦— EvRW â¦˜ â¨¾ po â¨¾ â¦— EvFâ‚œ MM â¦˜ â¨¾ po â¨¾ â¦— EvRW â¦˜ ) x y â†’ Fob x y

    fob-tsoâ‚ : ( â¦— EvW â¦˜ â¨¾ po â¨¾ â¦— EvFâ‚œ TSO â¦˜ â¨¾ po â¨¾ â¦— EvW â¦˜ )  x y â†’ Fob x y
    fob-tsoâ‚‚ : ( â¦— EvR â¦˜ â¨¾ po â¨¾ â¦— EvFâ‚œ TSO â¦˜ â¨¾ po â¨¾ â¦— EvRW â¦˜ ) x y â†’ Fob x y

  private
    variable
      uid : UniqueId
      tid : ThreadId
      loc : Location
      val : Value
      tag : Tag


  -- | Predicate stating the event has an acquire annotation
  data EvAcq : Predâ‚€ Event where
    ev-acq-r : {rel : Bool} â†’ EvAcq (event-r uid tid loc val (lab-r tag (true â¦‚annâ¦‚ rel)))
    ev-acq-w : {rel : Bool} â†’ EvAcq (event-w uid tid loc val (lab-w tag (true â¦‚annâ¦‚ rel)))

  -- | Predicate stating the event has an release annotation
  data EvRel : Predâ‚€ Event where
    ev-rel-r : {acq : Bool} â†’ EvRel (event-r uid tid loc val (lab-r tag (acq â¦‚annâ¦‚ true)))
    ev-rel-w : {acq : Bool} â†’ EvRel (event-w uid tid loc val (lab-w tag (acq â¦‚annâ¦‚ true)))

  -- | Predicate stating the event has both acquire and release annotations
  data EvSc : Predâ‚€ Event where
    ev-acqrel-r : EvSc (event-r uid tid loc val (lab-r tag ann-acqrel))
    ev-acqrel-w : EvSc (event-w uid tid loc val (lab-w tag ann-acqrel))

  -- From "Preserved Program Order" in RISC-V manual section 14.1
  data Ppo (x y : Event) : Set where
    ppoâ‚  : ( â¦— EvRW â¦˜ â¨¾ po-loc â¨¾ â¦— EvW â¦˜ )                x y â†’ Ppo x y
    ppoâ‚‚  : ( ( â¦— EvR â¦˜ â¨¾ po-loc-no-w â¨¾ â¦— EvR â¦˜ ) \â‚‚ rsw ) x y â†’ Ppo x y
    -- From manual:
    -- > "a is generated by an AMO or SC instruction, b is a load, and b returns a value written by a"
    ppoâ‚ƒ  : ( â¦— EvWâ‚œ trmw âˆªâ‚ EvSc â¦˜ â¨¾ rfi â¨¾ â¦— EvR â¦˜ ) x y â†’ Ppo x y
    -- # Explicit Synchronization
    ppoâ‚„  : Fob                                              x y â†’ Ppo x y
    ppoâ‚…  : ( â¦— EvAcq â¦˜ â¨¾ po â¨¾ â¦— EvRW â¦˜ )                    x y â†’ Ppo x y
    ppoâ‚†  : ( â¦— EvRW â¦˜ â¨¾ po â¨¾ â¦— EvRel â¦˜ )                    x y â†’ Ppo x y
    ppoâ‚‡  : ( â¦— EvAcq âˆªâ‚ EvRel â¦˜ â¨¾ po â¨¾ â¦— EvAcq âˆªâ‚ EvRel â¦˜ ) x y â†’ Ppo x y
    ppoâ‚ˆ  : rmw                                              x y â†’ Ppo x y
    -- # Syntactic Dependencies
    ppoâ‚‰  : addr               x y â†’ Ppo x y
    ppoâ‚â‚€ : dataâ‚‹              x y â†’ Ppo x y
    ppoâ‚â‚ : ( ctrl â¨¾ â¦— EvW â¦˜ ) x y â†’ Ppo x y
    -- # Pipeline Dependencies
    ppoâ‚â‚‚ : ( ( addr âˆªâ‚‚ dataâ‚‹ ) â¨¾ rfi â¨¾ â¦— EvR â¦˜ ) x y â†’ Ppo x y
    ppoâ‚â‚ƒ : ( addr â¨¾ po â¨¾ â¦— EvW â¦˜ )               x y â†’ Ppo x y


  record IsRISCVConsistent : Set where
    field
      data-defâ‚ : dataâ‚‹ âŠ†â‚‚ EvR Ã—â‚‚ EvW
      data-defâ‚‚ : dataâ‚‹ âŠ†â‚‚ po
      addr-defâ‚ : addr  âŠ†â‚‚ EvR Ã—â‚‚ ( EvR âˆªâ‚ EvW )
      addr-defâ‚‚ : dataâ‚‹ âŠ†â‚‚ po
      ctrl-defâ‚ : ctrl  âŠ†â‚‚ EvR Ã—â‚‚ EvE
      ctrl-defâ‚‚ : ctrl  âŠ†â‚‚ po
      ctrl-defâ‚ƒ : ( ctrl â¨¾ po ) âŠ†â‚‚ ctrl

      -- # Armv8-specific consistency constraints

      ax-coherence : Acyclic _â‰¡_ ( co âˆªâ‚‚ rf âˆªâ‚‚ fr âˆªâ‚‚ po-loc ) -- "Internal Visibility"
      ax-model     : Acyclic _â‰¡_ ( co âˆªâ‚‚ rfe âˆªâ‚‚ fr âˆªâ‚‚ Ppo )
      ax-atomicity : Emptyâ‚‚ ( rmw âˆ©â‚‚ (fre â¨¾ coe) )
